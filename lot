#!/bin/sh

# MIT License
# 
# Copyright (c) 2019-2020 Hyeonki Hong <hhk7734@gmail.com>
# 
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
# 
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

# Pre-requisite
# Installation package
# Enable/Disable Spi, I2c, Uart, Etc.
# Pin number/function/status/mode/Etc.

BLACK=$(tput setaf 0)
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
ORANGE=$(tput setaf 3)
BLUE=$(tput setaf 4)
PURPLE=$(tput setaf 5)
CYAN=$(tput setaf 6)
LGRAY=$(tput setaf 7)

BOLD=$(tput bold)

DEFAULT=$(tput sgr0)

if [ "$(id -u)" -ne 0 ]; then
    printf "%s %s\n\n" "${RED}${BOLD}Must run as root privileges." \
        "Try 'sudo lot [options]'${DEFAULT}"
    exit 1
fi

if [ -z "${SUDO_USER}" ]; then
    export SUDO_USER=${USER}
fi

if [ -e '/usr/lib/lot-scripts' ]; then
    . /usr/lib/lot-scripts/*
else
    printf "Failed to find /usr/lib/lot-scripts."
    exit 1
fi

do_detect_os()
{
    if cat /etc/*-release | grep -q "Ubuntu" ; then
        LOT_OS=Ubuntu
    else
        LOT_OS=unknown
    fi

    echo ${LOT_OS}
}

LOT_OS=$(do_detect_os)
LOT_DEVICE=$(do_detect_board)

printf "\n%s\n" "${CYAN}${BOLD}USER:   ${SUDO_USER}${DEFAULT}"
printf "%s\n"   "${CYAN}${BOLD}OS:     ${LOT_OS}${DEFAULT}"
printf "%s\n\n" "${CYAN}${BOLD}Device: ${LOT_DEVICE}${DEFAULT}"

case "$1" in
    install|uninstall)
        if [ "${LOT_DEVICE}" != "unknown" ]; then
            if [ "$1" = "install" ];then
                apt-get update
                apt-get install -y lot-"${LOT_DEVICE}"
            else
                apt-get purge -y lot-"${LOT_DEVICE}"
            fi
        else
            printf "Failed to %s lot-SBC, Unknown device.\n" "$1"
            exit 1
        fi
    ;;

    *)
        printf "Unknown argument '%s'\n" "$1" >&2
        exit 1
    ;;
esac
